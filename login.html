<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Log-in</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-firestore.js"></script>
	<script>

		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyDg8cKLvS8KuVCxeahzMNQJvt5FG7r4Ay8",
			authDomain: "pixelmeme-4e7cf.firebaseapp.com",
			databaseURL: "https://pixelmeme-4e7cf.firebaseio.com",
			projectId: "pixelmeme-4e7cf",
			storageBucket: "gs://pixelmeme-4e7cf.appspot.com/",
			messagingSenderId: "548501828671"
		};
		var app = firebase.initializeApp(config);
		db = firebase.firestore(app);
	</script>
</head>
<body>
<div id="regSign">
	<input type="text" id="email" name="email" placeholder="Email...">
	<input type="password" id="password" name="password" placeholder="Password...">
	<button id="signup">SignUp</button>
	<button id="signin">SignIn</button>
</div>

<script>
	$('#signin').click(function () {
		var email = $('#email').val();
		var password = $('#password').val();
		if (email.length < 4) {
			alert('Please enter an email address.');
			return;
		}
		if (password.length < 4) {
			alert('Please enter a password.');
			return;
		}
		app.auth().signInWithEmailAndPassword(email, password).catch(function (error) {
			var errorCode = error.code;
			var errorMessage = error.message;
			console.log("EC: ", errorCode, " EM: ", errorMessage);
			if (errorCode === 'auth/wrong-password' || errorCode === 'auth/user-not-found') {
				alert(errorCode);
			} else {
				alert(errorMessage);
			}
		});
	});

	$('#signup').click(function () {
		var email = $('#email').val();
		var password = $('#password').val();
		if (email.length < 4) {
			alert('Please enter an email address.');
			return;
		}
		if (password.length < 4) {
			alert('Please enter a password.');
			return;
		}
		app.auth().createUserWithEmailAndPassword(email, password).catch(function (error) {
			var errorCode = error.code;
			var errorMessage = error.message;
			if (errorCode === 'auth/weak-password') {
				alert('The password is too weak.');
			} else if(errorCode === 'auth/email-already-in-use'){
				alert('This email is already in use');
			}else {
				alert(errorMessage);
			}
			console.log(error);
		});
	});

	app.auth().onAuthStateChanged(function (user) {
		if (user) {
			console.log("user signed in!");
			console.log(user.uid);
			var docRef = db.collection("users").doc(user.uid);
			docRef.get().then(function (doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					window.location.replace("index.html");
				} else {
					console.log("No such document!");
					console.log("Making document!");
					db.collection("users").doc(user.uid).set({
						uid: user.uid,
						username: user.email,
						displayName: user.displayName
					}).then(function () {
						window.location.replace("index.html");
					});

				}

			}).catch(function (error) {
				console.log("Error occured:", error);
			});

		}
	});
</script>
</body>
</html>